---
title: "Rat Sightings Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(lubridate)
library(dplyr)
```

```{r rat sightings}
sightings = read_csv('data/NYC_Rat_Sightings.csv') |>
  janitor::clean_names() |>
  separate(created_date, into=c("month","e", "day","f", "year", "g", "time"), sep=c(2,3,5,6,10,11)) |>
  select(-e,-f,-g) |>
  mutate(date = paste(year, month, day, sep=""),
         date = as.numeric(date)) |> 
  filter(date <= 20231031,
         date >= 20160101,
         !incident_zip <= 10000,
         !incident_zip > 11697,
         !borough %in% c("Unspecified", NA)) |>
  select(-agency, -agency_name, -complaint_type, -descriptor, -landmark, -facility_type, -park_facility_name, -vehicle_type, -taxi_company_borough, -taxi_pick_up_location, -bridge_highway_name, -road_ramp, -bridge_highway_segment, -bridge_highway_direction) |> select(unique_key, date, year, month, day, everything())
```

```{r}
weather_df = rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2016-01-01",
    date_max = "2022-12-31") |>
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) |>
  select(name, id, everything())
```


Merge weather and rat data
```{r}
sightings$date <- as.Date(as.character(sightings$date), format = "%Y%m%d")

rat_weather =
  right_join(sightings, weather_df, by="date")
```

Let's first see how the number of rat sightings in NYC have changed over time. We can see that sightings went up drastically since 2020, when the rat populations were able to thrive as people were quarantined inside.

```{r}
# total count per year - sharp increase after 2020, peak 2022
sightings |> group_by(year) |>
  summarize(count=n()) |>
  plot_ly(x=~year, y=~count, type="scatter", mode="line")
```

And if we look by time of year, we find that in each year May through October have the highest count of rat sightings.

```{r}
# trends by month of the year - bulk between april/may to october/november
sightings |> 
  group_by(year,month) |> 
  summarize(count = n()) |> 
  ggplot(aes(x=month, y=count, color=year, group=year)) + geom_line() 
```

Rat sightings per day
```{r}
rat_weather |>
  mutate(year = as.factor(year)) |>
  group_by(date) |>
  summarize(count = n(), year) |>  
  ggplot(aes(x = date, y = count, color=year)) +
  geom_point(alpha = 0.25) + 
  labs(title = "Time Series: Rat Sightings Over Time",
       x = "Date",
       y = "Number of Rat Sightings")
```

Let's further break down these trends by borough:

```{r}
# total count per year by borough - most in brooklyn and manhattan
sightings |> 
  group_by(year, borough) |> 
  summarize(count=n()) |> 
  plot_ly(x=~year, y=~count, color=~borough, type="scatter", mode="line")
```

Rat sightings by latitude and longitude

```{r}
rat_weather |>
  sample_n(10000) |>
  plot_ly(x = ~longitude, y = ~latitude, type = "scatter", mode = "markers",
        color = ~borough, colors = c("blue", "red", "green", "purple", "orange")) |> 
  layout(title = "Rat Sightings by Latitude and Longitude",
         xaxis = list(title = "Longitude"),
         yaxis = list(title = "Latitude"))
```


In April 2023, a "Rat Czar" was appointed to tackle the problem of rat presence across the city. Let's map the number of rat sightings and the linear regression in the 6 months pre vs. post-appointment.

```{r}
# looking at rat czar effects
rat_czar = sightings |>
  filter(date >= 20221001) |> 
  group_by(year, month) |>
  summarize(count=n()) |>
  mutate(month_year = paste(month, year, sep="_"),
         month_year = as.factor(month_year)) 
```

```{prepost counts}
# graph of counts per month, 6 months before and after coronation
rat_czar |>
  ggplot(aes(x=month_year, y=count)) + geom_point() + geom_vline(xintercept="04_2023", color="red", linetype="dashed") + theme(axis.text.x=element_text(angle=90))
```

```{prereg}
# linear regression before and after
# 6 months before
czar_before = rat_czar |> filter(month_year %in% c("10_2022","11_2022", "12_2022", "01_2023", "02_2023", "03_2023", "04_2023")) |>
  mutate(months = case_when(month_year == "10_2022" ~ 1,
                           month_year =="11_2022" ~ 2,
                          month_year == "12_2022" ~ 3,
                         month_year ==  "01_2023" ~ 4,
                         month_year ==  "02_2023" ~ 5,
                          month_year == "03_2023" ~ 6,
                         month_year == "04_2023" ~ 7)) 
```

```{before}
czar_before |> ggplot(aes(x=months, y=count)) + geom_point() + geom_line()

czar_before |>
  lm(count~months, data=_) |> broom::tidy() |> knitr::kable()
# slope is increasing but NOT significant  (y= 1581.14 + 58.39x)
```

```{postreg}
czar_after = rat_czar |> filter(month_year %in% c("04_2023","05_2023","06_2023", "07_2023", "08_2023", "09_2023", "10_2023")) |>
  mutate(months = case_when(month_year == "04_2023" ~ 1,
                            month_year == "05_2023" ~ 2,
                           month_year =="06_2023" ~ 3,
                          month_year == "07_2023" ~ 4,
                         month_year ==  "08_2023" ~ 5,
                         month_year ==  "09_2023" ~ 6,
                          month_year == "10_2023" ~ 7)) 

czar_after |> ggplot(aes(x=months, y=count)) + geom_point() + geom_line()

czar_after |>
  lm(count~months, data=_) |> broom::tidy() |> knitr::kable()
# slope is decreasing but also not significant ( y= 2441.29 - 5.71x)
```

While we find that there are changes in the slope post-appointment, they are not statistically significant. As such, it seems like there are probably a number of other factors associated with rat sightings.

